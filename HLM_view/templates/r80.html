{% extends 'base.html' %}
{% load static %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'index' %}">Overview</a></li>
      <li class="breadcrumb-item active" aria-current="page">R80</li>
    </ol>
</nav>
{% endblock %}

{% block javascript %}
<script>
    $(document).ready(function() {
        var element = document.getElementById("nav-r80");
        element.classList.add("active");
    })
</script>

<script>
    /* Formatting function for row details - modify as you need */
    function format ( rowData ) {
        // `rowData` is the original data object for the row
        return  '<table id="' + rowData.id + '" class="table table-bordered table-hover table-sm mx-auto" style="width: 90%;">'+
                '</table>';   
    }

    $(document).ready(function() {
        var table = $('#coordinators-table').DataTable( {
            retrieve: true,
            searching: false,
            paging: false,
            info: false,
            order: [[1, "asc"]],
            language: {
                emptyTable: "No coordinators found for R80." // TODO: UPDATE DEPENDING ON BUILDING
            },
            ajax: {
                url: "{% url 'coordinators_data' %}",
                type: 'GET',
                dataSrc: 'R80.coordinators' // TODO: UPDATE DEPENDING ON BUILDING
            },
            columns: [
                {"data": "id"},
                {"data": "name"},
                {"data": "he_total"},
                {"data": "devices.length"}
            ],
            columnDefs: [
                {
                    targets: 1,
                    className: "coord-name"
                },
                {
                    targets: 3,
                    className: "show-devices",
                    render: function(data, type, row, meta) {
                        if (type == 'display') {
                            if (data !== null) {
                                data = data + 
                                    '<span class="float-right px-3 cursor-pointer">' + 
                                        '<i class="bi bi-zoom-in"></i>' +
                                    '</span>';
                            }
                        }
                        return data;
                    }
                }
            ],
            initComplete: function() {
                $("#objects-table").width("100%");
            }
        });

        // Add event listener for opening and closing coordinator devices
        $('#coordinators-table tbody').on('click', '.show-devices', function () {
            var tr = $(this).closest('tr');
            var row = table.row( tr );
            var rowData = row.data();
            var coordinatorName = $(tr).find("td.coord-name")

            if ( row.child.isShown() ) {
                // This row is already open - close it
                row.child.hide();
                $("i", this).toggleClass("bi bi-zoom-in bi-zoom-out");

                coordinatorName.removeClass("font-weight-bold");

                // Destroy the nested datatable
                $('#' + rowData.id).DataTable().destroy();
            }
            else {
                // Open this row
                row.child( format(rowData) ).show();

                coordinatorName.addClass("font-weight-bold");

                // Create the nested datatable for devices
                $( '#' + rowData.id ).DataTable( {
                    data: rowData.devices,
                    dataSrc: '',
                    retrieve: true,
                    searching: false,
                    paging: false,
                    info: false,
                    order: [[1, "asc"]],
                    language: {
                        emptyTable: "No devices found for this coordinator."
                    },
                    columns: [
                        { data: "id", title: "Device ID"},
                        { data: "name", title: "Device Name"},
                        { data: "value", title: "Value"}
                    ]
                });
                
                $("i", this).toggleClass("bi bi-zoom-in bi-zoom-out");
            }
        } );

        setInterval( function () {
            table.ajax.reload( null, false );
        }, 300000 );
    });
</script>
{% endblock %}

{% block content %}
<div class="mx-5 my-3">
    <h2 class="font-weight-normal text-center">R80 - Target Station 2</h2>
    <hr>
    <h3 class="font-weight-normal">Helium levels</h3>
    <br>

    <table class="table table-bordered table-hover table-sm" id="coordinators-table">
        <thead>
            <tr>
                <th scope="col">Object ID</th>
                <th scope="col">Coordinator Name</th>
                <th scope="col">Total Helium</th>
                <th scope="col">Connected Devices</th>
            </tr>
        </thead>
        <tbody>
            <!-- Populate body with AJAX sourced data -->
        </tbody>
    </table>

    <hr>

    <h3 class="font-weight-normal mb-3">TS2 Map</h3>
    <img src="{% static 'images/R80_map.png' %}" alt="R80 Map" style="width: 100%">
</div>
{% endblock %}
